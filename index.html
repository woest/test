<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8' />
<title>Cumulatief neerslagtekort 2018</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.3.0/mapbox-gl.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/d3/5.11.0/d3.min.js' charset='utf-8'></script>
<link href='https://www.mapbox.com/base/latest/base.css' rel='stylesheet' />
<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.3.0/mapbox-gl.css' rel='stylesheet' />
<style>
    body {
        margin:0;
        padding:0;
    }

    #map {
        position:absolute;
        top:0;
        bottom:0;
        width:100%;
    }

    .map-overlay {
        font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        position: absolute;
        width: 25%;
        top: 0;
        left: 0;
        padding: 10px;
    }

    .map-overlay .map-overlay-inner {
        background-color: #fff;
        box-shadow:0 1px 2px rgba(0, 0, 0, 0.20);
        border-radius: 3px;
        padding: 10px;
        margin-bottom: 10px;
    }

    .map-overlay h2 {
        line-height: 24px;
        display: block;
        margin: 0 0 10px;
    }

    .map-overlay .legend .bar {
        height: 10px;
        width: 100%;
        background: linear-gradient(to right, #FCA107, #7F3121);
    }

    .map-overlay input {
        background-color: transparent;
        display: inline-block;
        width: 100%;
        position: relative;
        margin: 0;
        cursor: ew-resize;
    }
</style>
</head>
<body>
    <div id='map'></div>

    <div class='map-overlay top'>
        <div class='map-overlay-inner'>
            <h2>Cumulatief neerslagtekort in 2018 ten opzichte van april 2018</h2>
            <label id='month'>Loading...</label>
            <input id='slider' type='range' min='0' max='11' step='1' value='0' />
        </div>
        <div class='map-overlay-inner'>
            <div id='legend' class='legend'>
                <div class='bar'></div>
                <div>Magnitude (m)</div>
            </div>
        </div>
        <div class='rounded-toggle fr col4'>
            <input id='pizza' type='radio' name='rtoggle' value='pizza' checked='checked'>
            <label for='pizza' class='col6 center' onclick='tilt(false)'>2D</label>
            <input id='penny' type='radio' name='rtoggle' value='penny'>
            <label for='penny' class='col6 center' onclick='tilt(true)'>3D</label>
        </div>
    </div>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiaGt2c3VwZXJzZWMiLCJhIjoiY2p0azZhdXZnMHN5dTQ0bjBta3BqMmdhaSJ9.84tun-jmHukg2mmI3dXb7g';
            var map = new mapboxgl.Map({
            container: "map",
            style: "mapbox://styles/mapbox/light-v10",
            center: [5.3, 52.2],
            zoom: 7,
            pitch: 0,
            antialias: true
        });

        var months = [
            'January',
            'February',
            'March',
            'April',
            'May',
            'June',
            'July',
            'August',
            'September',
            'October',
            'November',
            'December'
        ];
        
        var current_month = 3;

        function filterBy(month) {
            document.getElementById('slider').value = month.toString();
            var filters = ['==', 'month', months[month]];
            map.setFilter('rain', filters);
            console.log(months[month]);
            document.getElementById('month').textContent = months[month];
        }

        map.on('load', function() {
            console.log('map loaded');

            d3.json('total.json').then(function(data) {
                console.log('data loaded');

                map.addSource('rain', {
                    'type': 'geojson',
                    data: data
                });
                console.log('data added');

                map.addLayer({
                    'id': 'rain',
                    'type': 'fill-extrusion',
                    'source': 'rain',
                    'paint': {
                        'fill-extrusion-color': ['get', 'color'],
                        'fill-extrusion-opacity': 1.0,
                        'fill-extrusion-height': [
                            'interpolate', ['linear'], ['zoom'],
                            3, 0,
                            7.05, ['*', 100, ['get', 'cum_deficit']]
                        ],
                        'fill-extrusion-base': 0
                    }
                });
                console.log('layer added');

                // Set filter to current month
                filterBy(current_month);

                document.getElementById('slider').addEventListener('input', function(e) {
                    var month = parseInt(e.target.value, 10);
                    filterBy(month);
                });

                // Tilt to 2D
                tilt(false)
            });
        });

        // map tilt functionality
        function tilt(eh){
            if (eh){
                document.getElementById('pizza').checked = false;
                document.getElementById('penny').checked = true;
            } 
            else {
                document.getElementById('pizza').checked = true;
                document.getElementById('penny').checked = false;
            }
            var state = !eh ? {pitch:0, klass:['']} : {pitch:50, klass:['tilted']}
            document.querySelector('#map').className = 'pin-bottomright scale '+state.klass[0]
            map
                .easeTo({pitch: state.pitch})
                //.setClasses(state.klass)

            //scale.fire('resize');
        }
    </script>

</body>
</html>